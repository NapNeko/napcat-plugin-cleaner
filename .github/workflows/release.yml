name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +'%Y%m%d%H%M%S')"
          fi
          # å»æ‰å‰é¢çš„ 'v' å­—ç¬¦ç”¨äº package.json
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.clean_version }} --no-git-tag-version --allow-same-version

      - name: Build project
        run: pnpm run build

      - name: Prepare release package
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºç»„ç»‡æ–‡ä»¶
          mkdir -p release
          
          # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          cp dist/index.mjs release/
          cp package.json release/
          cp -r webui release/
          
          # è¿›å…¥ä¸´æ—¶ç›®å½•å¹¶å‹ç¼©
          cd release
          zip -r ../napcat-plugin-cleaner.zip index.mjs package.json webui
          
      - name: Verify zip contents
        run: |
          unzip -l napcat-plugin-cleaner.zip

      - name: Create Release Note via AI
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          OPENROUTER_API_URL: "https://91vip.futureppo.top/v1/chat/completions"
          OPENROUTER_MODEL: "copilot/gemini-3-flash-preview"
          GITHUB_OWNER: "NapNeko"
          GITHUB_REPO: "napcat-plugin-cleaner"
        run: |
          set -euo pipefail
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          
          # è·å–æ‰€æœ‰ tag å¹¶æŒ‰ç‰ˆæœ¬æ’åº
          git fetch --tags --force
          
          # è·å–æœ€æ–°çš„å·²å­˜åœ¨ tag ä½œä¸ºä¸Šä¸€ä¸ªç‰ˆæœ¬
          PREV_TAG=$(git tag -l "v*" --sort=version:refname | tail -1)
          
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä»»ä½• tagï¼Œä½¿ç”¨ä»“åº“çš„ç¬¬ä¸€ä¸ª commit
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"

          # è·å–æäº¤è®°å½•å’Œå·®å¼‚ï¼ˆä½¿ç”¨ HEAD è€Œä¸æ˜¯å¯èƒ½ä¸å­˜åœ¨çš„ CURRENT_TAGï¼‰
          COMMITS=$(git log --pretty=format:'- %s (%h)' "$PREV_TAG"..HEAD 2>/dev/null || git log --pretty=format:'- %s (%h)' -10)
          SUMMARY_LINE=$(git diff --stat "$PREV_TAG"..HEAD | tail -1 || echo "No changes")
          FILE_CHANGES=$(git diff --stat "$PREV_TAG"..HEAD | head -n -1 | head -30 || echo "")
          CODE_DIFF=$(git diff "$PREV_TAG"..HEAD -- '*.ts' | head -c 5000 || echo "Diff too large or no code changes")

          # æ„å»ºè¯·æ±‚
          SYSTEM_PROMPT=$(cat .github/prompt/release_note_prompt.txt)
          USER_CONTENT="å½“å‰ç‰ˆæœ¬: $CURRENT_TAG
          ä¸Šä¸€ç‰ˆæœ¬: $PREV_TAG
          æ—¥æœŸ: $(date +'%Y-%m-%d')
          
          ## æäº¤åˆ—è¡¨
          $COMMITS
          
          ## æ–‡ä»¶å˜åŒ–ç»Ÿè®¡
          $SUMMARY_LINE
          
          ## å˜æ›´æ–‡ä»¶åˆ—è¡¨
          $FILE_CHANGES
          
          ## å…³é”®ä»£ç å˜åŒ–é¢„è§ˆ
          \`\`\`diff
          $CODE_DIFF
          \`\`\`"

          BODY=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_CONTENT" \
            --arg model "$OPENROUTER_MODEL" \
            '{model: $model, messages:[{role:"system", content:$system},{role:"user", content:$user}], temperature:0.2, max_tokens:1500}')

          RESPONSE=$(curl -s -X POST "$OPENROUTER_API_URL" \
            -H "Authorization: Bearer $OPENAI_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          RELEASE_BODY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // ""')

          if [ -n "$RELEASE_BODY" ] && [ "$RELEASE_BODY" != "null" ]; then
            echo -e "$RELEASE_BODY" > CHANGELOG.md
            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/{VERSION}/$CURRENT_TAG/g" CHANGELOG.md
            sed -i "s/{PREV_VERSION}/$PREV_TAG/g" CHANGELOG.md
          else
            sed "s/{VERSION}/$CURRENT_TAG/g" .github/prompt/default.md | sed "s/{PREV_VERSION}/$PREV_TAG/g" > CHANGELOG.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          files: |
            napcat-plugin-cleaner.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Plugin Index Release and Create PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.clean_version }}"
          TAG_VERSION="${{ steps.version.outputs.version }}"
          PLUGIN_ID="napcat-plugin-cleaner"
          INDEX_REPO="NapNeko/napcat-plugin-index"
          INDEX_RELEASE_TAG="v1.0.0"
          FORK_OWNER="${{ github.repository_owner }}"
          BRANCH_NAME="update-${PLUGIN_ID}-${TAG_VERSION}"
          
          echo "ğŸ“¦ Updating plugin index for ${PLUGIN_ID} to version ${VERSION}"
          
          # ä¸Šä¼ æ’ä»¶ zip åˆ° napcat-plugin-index çš„ release
          echo "ğŸ“¤ Uploading plugin zip to ${INDEX_REPO} release ${INDEX_RELEASE_TAG}"
          
          # å…ˆåˆ é™¤å·²å­˜åœ¨çš„åŒåæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
          gh release delete-asset "${INDEX_RELEASE_TAG}" "${PLUGIN_ID}.zip" --repo "${INDEX_REPO}" --yes || true
          
          # ä¸Šä¼ æ–°çš„ zip æ–‡ä»¶
          gh release upload "${INDEX_RELEASE_TAG}" "../napcat-plugin-cleaner/${PLUGIN_ID}.zip" --repo "${INDEX_REPO}" --clobber
          
          echo "âœ… Plugin zip uploaded successfully"
          
          # æ›´æ–° release è¯´æ˜
          RELEASE_BODY="# NapCat Plugin Index

          ## æ’ä»¶åˆ—è¡¨

          - **napcat-plugin-builtin** - å†…ç½®æ’ä»¶
          - **napcat-plugin-cleaner** - æ¸…ç†æ’ä»¶ (${TAG_VERSION})

          ---
          
          > æ­¤ Release ç”¨äºæ‰˜ç®¡ NapCat æ’ä»¶èµ„æºæ–‡ä»¶
          
          **Full Changelog**: https://github.com/${INDEX_REPO}/commits/${INDEX_RELEASE_TAG}"
          
          gh release edit "${INDEX_RELEASE_TAG}" --repo "${INDEX_REPO}" --notes "${RELEASE_BODY}"
          
          echo "âœ… Release notes updated"
          
          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fork ä»“åº“ï¼ˆå¦‚æœå·²å­˜åœ¨ä¼šè·³è¿‡ï¼‰
          gh repo fork "${INDEX_REPO}" --clone=false || true
          
          # å…‹éš† fork çš„ä»“åº“
          cd ..
          rm -rf napcat-plugin-index
          gh repo clone "${FORK_OWNER}/napcat-plugin-index" -- --depth=1
          cd napcat-plugin-index
          
          # åŒæ­¥ä¸Šæ¸¸
          git remote add upstream "https://github.com/${INDEX_REPO}.git" || true
          git fetch upstream main
          git checkout -B "${BRANCH_NAME}" upstream/main
          
          # å›ºå®šä¸‹è½½é“¾æ¥åˆ° napcat-plugin-index çš„ release
          DOWNLOAD_URL="https://github.com/${INDEX_REPO}/releases/download/${INDEX_RELEASE_TAG}/${PLUGIN_ID}.zip"
          UPDATE_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # ä½¿ç”¨ jq æ›´æ–°ç‰ˆæœ¬å·å’Œä¸‹è½½é“¾æ¥
          jq --arg id "${PLUGIN_ID}" \
             --arg version "${VERSION}" \
             --arg downloadUrl "${DOWNLOAD_URL}" \
             --arg updateTime "${UPDATE_TIME}" \
             '
             .updateTime = $updateTime |
             .plugins = [.plugins[] | if .id == $id then .version = $version | .downloadUrl = $downloadUrl else . end]
             ' plugins.v4.json > plugins.v4.json.tmp && mv plugins.v4.json.tmp plugins.v4.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet plugins.v4.json; then
            echo "â­ï¸ No changes detected, skipping PR creation"
            exit 0
          fi
          
          # æäº¤å¹¶æ¨é€
          git add plugins.v4.json
          git commit -m "chore(${PLUGIN_ID}): update to ${TAG_VERSION}"
          git push -f "https://${GH_TOKEN}@github.com/${FORK_OWNER}/napcat-plugin-index.git" "${BRANCH_NAME}"
          
          # åˆ›å»º PRï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          PR_TITLE="chore(${PLUGIN_ID}): update to ${TAG_VERSION}"
          PR_BODY="## ğŸ”„ Plugin Update

          - **Plugin**: ${PLUGIN_ID}
          - **Version**: ${VERSION}
          - **Download**: ${DOWNLOAD_URL}
          - **Source Release**: https://github.com/${{ github.repository }}/releases/tag/${TAG_VERSION}

          ---
          *This PR was automatically created by GitHub Actions.*"
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ PR
          EXISTING_PR=$(gh pr list --repo "${INDEX_REPO}" --head "${FORK_OWNER}:${BRANCH_NAME}" --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… PR #${EXISTING_PR} already exists, updated branch"
          else
            gh pr create \
              --repo "${INDEX_REPO}" \
              --head "${FORK_OWNER}:${BRANCH_NAME}" \
              --base main \
              --title "${PR_TITLE}" \
              --body "${PR_BODY}"
            echo "âœ… PR created successfully"
          fi
